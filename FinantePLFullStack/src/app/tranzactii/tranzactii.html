<div class="container">
	
	
	
	<div class="top-header-box">
  <!-- 🟢 Stânga -->
  <div class="left-section">
    <h2>📊 Tranzacții ING (din API)</h2>
    <mat-slide-toggle [(ngModel)]="hoverMode">Activează Hover</mat-slide-toggle>
  </div>

  <!-- 🟣 Centru -->
  <div class="center-section">
    <span class="label">💰 Profit total:</span>
    <span class="value profit" [style.color]="profitHeader >= 0 ? '#00ff99' : '#ff5555'">
  {{ profitHeader | number:'1.2-2' }} lei
</span>

    <!-- 🌙 Selector de lună custom -->
<div class="luna-selector" (click)="toggleDropdownLuni()">
  <mat-icon class="calendar-icon">calendar_today</mat-icon>
  <span class="luna-text">
    {{ getNumeLuna(lunaSelectata) | uppercase }}
  </span>
  <mat-icon class="arrow-icon">{{ showDropdownLuni ? 'expand_less' : 'expand_more' }}</mat-icon>
</div>

<!-- 🔽 Dropdown-ul cu lunile -->
<div class="luni-dropdown" *ngIf="showDropdownLuni">
  <div
    class="luna-item"
    *ngFor="let luna of luni"
    [class.active]="isLunaActiva(luna)"
    (click)="selecteazaLuna(luna)"
  >
    {{ luna.nume | uppercase }}
  </div>
</div>



    <span class="label" style="margin-left: 20px;">💳 Total cheltuieli:</span>
    <span class="value cheltuieli" style="color:#ff6666;">
  {{ cheltuieliHeader | number:'1.2-2' }} lei
</span>
  </div>

  <!-- 🔵 Dreapta -->
  <div class="right-section">
    <span class="label">🧮 Total curent:</span>
    <span class="value">{{ getBannerTotal() | number:'1.2-2' }} lei</span>
  </div>
</div>




	
	<!-- 🔹 GRUP BUTOANE – IMPORT / OPERAȚIUNI -->
<div class="actions-wrapper">
  <!-- 🟦 BOX STÂNGA – Import & surse -->
  <div class="box-shadow import-box">
    <h4>📥 Import & surse</h4>
	<div class="import-filtrare-grid">
	  <!-- 🟢 Coloana 1 – Import & surse -->
    <div class="col-import">
	<!-- 🔹 Grup 1: sursă + import -->
  <div class="import-actions-group">
    <mat-radio-group [(ngModel)]="sursaSelectata" class="radio-group">
      <mat-radio-button value="ING">ING </mat-radio-button>
      <mat-radio-button value="PLUXEE">Pluxee</mat-radio-button>
    </mat-radio-group>

    <button mat-raised-button color="primary" (click)="importCsv()">
      <mat-icon>upload_file</mat-icon>
      Importă extrass
    </button>

    <mat-checkbox [(ngModel)]="autoSplitEnabled">AutoSplit automat</mat-checkbox>
  </div>

  <!-- 🔹 Grup 2: analitice -->
  <div class="import-analytics-group">
    <button mat-raised-button color="accent" (click)="showPie = !showPie">
      {{ showPie ? '❌ Închide Chart' : '📊 Vezi distribuția pe categorii' }}
    </button>
  </div>
	</div>
	 <!-- 🟣 Coloana 2 – Filtrare -->
    <div class="col-filtru">
      <h5>🔍 Filtrare tranzacții</h5>

      <mat-radio-group [(ngModel)]="filtruSursaVizual" class="filter-group">
        <mat-radio-button value="TOATE">Toate</mat-radio-button>
        <mat-radio-button value="ING">ING</mat-radio-button>
        <mat-radio-button value="PLUXEE">Pluxee</mat-radio-button>
        <mat-radio-button value="CASH">Cash</mat-radio-button>
      </mat-radio-group>

      <p class="hint-filtru">
        Alege sursa pentru a filtra doar tranzacțiile corespunzătoare în tabel.
      </p>
    </div>
	</div>

   
  </div>
	
  <!-- 🟩 BOX DREAPTA – Operațiuni -->
  <div class="box-shadow operations-box">
    <h4>⚙️ Operațiuni tranzacții</h4>


	<div class="operations-content">
	<!-- 🔹 STÂNGA: Operațiuni tranzacții -->
	<div class="operations-inner">
    <mat-form-field appearance="outline">
      <mat-label>Selectează categorie</mat-label>
      <mat-select [(ngModel)]="bulkCategorie">
        <mat-option *ngFor="let cat of categorii" [value]="cat">{{ cat }}</mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-raised-button color="primary" (click)="applyBulkUpdate()">
      ✅ Aplică pe liniile selectate
    </button>

    <button mat-raised-button color="accent" (click)="adaugaTranzactieNoua()">
      ➕ Adaugă tranzacție nouă
    </button>
	
	<!-- 🔹 SUMAR CONSUM -->
<div class="consum-summary">
  <div class="consum-item">
    <mat-icon class="beer-icon">sports_bar</mat-icon>
    <div class="consum-text">
      <span class="label">Beri:</span>
      <span class="value">{{ totalBeri }} x</span>
      <span class="price">{{ totalPretBeri | number:'1.2-2' }} lei</span>
    </div>
  </div>

  <div class="consum-item">
    <mat-icon class="cigarette-icon">smoking_rooms</mat-icon>
    <div class="consum-text">
      <span class="label">Țigări:</span>
      <span class="value">{{ totalTigari }} pachete</span>
      <span class="price">{{ totalPretTigari | number:'1.2-2' }} lei</span>
    </div>
  </div>
</div>

	

    <button *ngIf="hasSelection()" mat-raised-button color="warn" (click)="bulkDelete()">
      🗑️ Șterge selectate
    </button>
  </div>
  <!-- 🔹 Carduri totaluri ING / PLUXEE -->
 <!-- ===================================================
     🔁 DASHBOARD CARD SWITCH (Balanță ↔ Profit & Loss)
=================================================== -->







<div class="cards-col">
  <div class="cards-totale">

    <!-- 🔄 Buton mic de switch între moduri -->
    <div class="switch-mode-group">
      <div class="switch-mode" (click)="toggleDashboardMode()" matTooltip="Comută între Balanțe și P&L">
        <mat-icon>
          {{ showBalanceMode ? 'bar_chart' : 'account_balance_wallet' }}
        </mat-icon>
      </div>

    </div>

    <!-- 🪞 ANIMAȚIE FLIP 3D -->
    <div class="flip-container" [class.flipped]="!showBalanceMode">
      <div class="flipper">

        <!-- 🟦 FAȚA: Balanțe Reale -->
        <div class="front mode-view">

          <!-- 🏦 ING -->
          <div class="total-card ing">
            <div class="card-header-with-balance">
              <div class="left">
                <img src="assets/img/ing.png" alt="ING" class="icon-sursa" />
                <h4>ING</h4>
              </div>
              <div class="right">
                <span class="label">⚖️ Balanță totală:</span>
                <span class="value">{{ getBalanta('ING') | number:'1.2-2' }} lei</span>
              </div>
            </div>

            <div class="linie cheltuieli">
              <span>💳 Cheltuieli:</span>
              <strong>{{ getTotalCheltuieli('ING') | number:'1.2-2' }} lei</strong>
            </div>
            <div class="linie venituri">
              <span>💰 Venituri:</span>
              <strong>{{ getTotalVenituri('ING') | number:'1.2-2' }} lei</strong>
            </div>
          </div>

          <!-- 💳 PLUXEE -->
          <div class="total-card pluxee">
            <div class="card-header-with-balance">
              <div class="left">
                <img src="assets/img/pluxee.png" alt="PLUXEE" class="icon-sursa" />
                <h4>PLUXEE</h4>
              </div>
              <div class="right">
                <span class="label">⚖️ Balanță totală:</span>
                <span class="value">{{ getBalanta('PLUXEE') | number:'1.2-2' }} lei</span>
              </div>
            </div>

            <div class="linie cheltuieli">
              <span>💳 Cheltuieli:</span>
              <strong>{{ getTotalCheltuieli('PLUXEE') | number:'1.2-2' }} lei</strong>
            </div>
            <div class="linie venituri">
              <span>💰 Venituri:</span>
              <strong>{{ getTotalVenituri('PLUXEE') | number:'1.2-2' }} lei</strong>
            </div>
          </div>
        </div>

        <!-- 🟣 VERSO: Profit & Loss -->
        <div class="back pnl-view">

          <div class="pnl-cards-flex">
            <!-- ING P&L -->
            <div class="total-card ing">
		  <div class="card-header-with-balance">
			<div class="left">
			  <img src="assets/img/ing.png" alt="ING" class="icon-sursa" />
			  <h4>📊 ING P&L</h4>
			</div>
		  </div>

		  <div class="pnl-bar-dinamic">
			<div
			  class="pnl-fill"
			  [style.width.%]="getPnlPercent('ING')"
			  [style.background]="getProfitColor('ING')">
			</div>
		  </div>

		  <!-- 🔹 Toate pe un singur rând -->
		  <!-- 🔹 Toate pe un singur rând -->
		<div class="pnl-inline-row">
		  <div class="venituri">
			💰 Venituri:
			<b>{{ pnlIng.venituri | number:'1.2-2' }} lei</b>
		  </div>
		  <div class="cheltuieli">
			💳 Cheltuieli:
			<b>{{ pnlIng.cheltuieli | number:'1.2-2' }} lei</b>
		  </div>
		  <div class="profit">
			{{ pnlIng.profit >= 0 ? '📈 Profit net:' : '📉 Pierdere netă:' }}
			<b [style.color]="getProfitColor('ING')">
			  {{ pnlIng.profit | number:'1.2-2' }} lei
			</b>
		  </div>
		</div>

		</div>


            <!-- PLUXEE P&L -->
            <div class="total-card pluxee">
  <div class="card-header-with-balance">
    <div class="left">
      <img src="assets/img/pluxee.png" alt="PLUXEE" class="icon-sursa" />
      <h4>📈 PLUXEE P&L</h4>
    </div>
  </div>

  <!-- 🟩 Bara dinamică -->
		  <div class="pnl-bar-dinamic">
			<div
			  class="pnl-fill"
			  [style.width.%]="getPnlPercent('PLUXEE')"
			  [style.background]="getProfitColor('PLUXEE')">
			</div>
		  </div>

		  <!-- 🔹 Totul pe un singur rând -->
		  <div class="pnl-inline-row">
		  <div class="venituri">
			💰 Venituri:
			<b>{{ pnlPluxee.venituri | number:'1.2-2' }} lei</b>
		  </div>
		  <div class="cheltuieli">
			💳 Cheltuieli:
			<b>{{ pnlPluxee.cheltuieli | number:'1.2-2' }} lei</b>
		  </div>
		  <div class="profit">
			{{ pnlPluxee.profit >= 0 ? '📈 Profit net:' : '📉 Pierdere netă:' }}
			<b [style.color]="getProfitColor('PLUXEE')">
			  {{ pnlPluxee.profit | number:'1.2-2' }} lei
			</b>
		  </div>
		</div>

		</div>

          </div>

        </div> <!-- end back -->
      </div>
    </div>
  </div>
</div>


	</div>
  </div>



	
	
</div>

	<!-- ✅ Buton & Chart Pie -->

	<div class="chart-container" *ngIf="showPie">
		<div class="chart-actions">
			<button mat-raised-button color="primary" (click)="chartMode = 'pie'">🥧 Placinta</button>
			<button mat-raised-button color="accent" (click)="chartMode = 'bar'">📊 Bara</button>
			<button mat-raised-button color="warn" (click)="showPie = false">❌ Închide Chart</button>
		</div>

		<div class="pie-wrapper">
		  <canvas
			baseChart
			[data]="pieChartData"
			[options]="pieChartOptions"
			[type]="chartMode"
			[height]="550"      
			[width] ="900">
		  </canvas>
</div>
	</div>

	<!-- 🔥 OVERLAY DE ÎNCĂRCARE -->
	<div class="ocr-loader" *ngIf="isLoadingOcr">
  <div class="loader-box">
    <div class="spinner"></div>  <!-- 🔹 închis corect -->
    <p>Se procesează bonul OCR...</p>

    <div class="progress-container">
      <div class="progress-bar" [style.width.%]="uploadProgress"></div>
    </div>

    <p class="progress-text">{{ uploadProgress }}%</p>
  </div>
</div>
<div class="table-container">

	<!-- ================= TABLE ================= -->
	<table mat-table [dataSource]="getTranzactiiFiltrate()"
       class="mat-elevation-z8 full-width"
       [ngClass]="{'hover-enabled': hoverMode}"
       (mouseleave)="resetTotal()">
	   
	 <!-- 🔹 HEADERUL COMPLET – cu icoane + etichete -->
  <tr mat-header-row *matHeaderRowDef="displayedColumns" class="custom-header">
    <th mat-header-cell *matHeaderCellDef="let column" class="header-cell select">☑️</th>
    <th mat-header-cell *matHeaderCellDef="let column" class="header-cell id">🆔 ID</th>
    <th mat-header-cell *matHeaderCellDef class="header-cell">📅 Data</th>
    <th mat-header-cell *matHeaderCellDef class="header-cell">🔁 Tip tranzacție</th>
    <th mat-header-cell *matHeaderCellDef class="header-cell">💰 Sumă</th>
    <th mat-header-cell *matHeaderCellDef class="header-cell">💳 Tip plată</th>
    <th mat-header-cell *matHeaderCellDef class="header-cell">🆔 Sursa</th>
    <th mat-header-cell *matHeaderCellDef class="header-cell">📊 Sold final</th>
    <th mat-header-cell *matHeaderCellDef class="header-cell">💳 Nr. card</th>
    <th mat-header-cell *matHeaderCellDef class="header-cell">🧾 Merchant</th>
    <th mat-header-cell *matHeaderCellDef class="header-cell">🏷️ Categorie</th>
    <th mat-header-cell *matHeaderCellDef class="header-cell">🍺 # Beri</th>
    <th mat-header-cell *matHeaderCellDef class="header-cell">🚬 # Țigări</th>
    <th mat-header-cell *matHeaderCellDef class="header-cell">⚙️ Acțiuni</th>
  </tr>

  <!-- ID -->
  <ng-container matColumnDef="id">
    <th mat-header-cell *matHeaderCellDef>ID</th>
    <td mat-cell *matCellDef="let element">{{ element.id }}</td>
  </ng-container>

  <!-- 🔹 SURSA -->
<ng-container matColumnDef="sursaCard">
  <th mat-header-cell *matHeaderCellDef>Sursa</th>

  <td mat-cell *matCellDef="let element"
    (dblclick)="startEdit(element, 'sursaCard')"
    class="editable-cell"
    [class.just-updated]="element.justUpdated">


    <!-- 🔸 Mod vizualizare -->
    <ng-container *ngIf="!(editingCell?.id === element.id && editingCell?.field === 'sursaCard'); else editSursa">
      <span class="badge badge-sursa" [ngClass]="element.sursaCard?.toLowerCase()">
        {{ element.sursaCard || '-' }}
      </span>
    </ng-container>

    <!-- 🔸 Mod editare -->
    <ng-template #editSursa>
      <mat-form-field appearance="outline" style="width: 110px; margin: 0;">
        <mat-select [(ngModel)]="editValue"
                    (selectionChange)="saveEdit(element, 'sursaCard')"
                    (closed)="cancelEdit()"
                    panelClass="sursa-dropdown">
          <mat-option value="ING">
            <span class="badge-sursa ing">ING</span>
          </mat-option>
          <mat-option value="PLUXEE">
            <span class="badge-sursa pluxee">PLUXEE</span>
          </mat-option>
          <mat-option value="CASH">
            <span class="badge-sursa cash">CASH</span>
          </mat-option>
        </mat-select>
      </mat-form-field>
    </ng-template>

  </td>
</ng-container>



<!-- Data Tranzactie -->
<ng-container matColumnDef="dataTranzactie">
	<th mat-header-cell *matHeaderCellDef> Data tranzacție</th>
<td mat-cell *matCellDef="let element">
	<ng-container *ngIf="!element.editing; else editDate">
      {{ element.dataTranzactie | date:'dd/MM/yyyy' }}
	</ng-container>
	<ng-template #editDate>
	<input matInput type="date" [(ngModel)]="element.dataTranzactie"/>
</ng-template>
</td>
</ng-container>

<!-- Tip Tranzactie -->
<ng-container matColumnDef="tipTranzactie">
	<th mat-header-cell *matHeaderCellDef> Tip tranzacție</th>
<td mat-cell *matCellDef="let element">

	<!-- 🔸 Mod vizualizare -->
	<ng-container *ngIf="!element.editing; else editTip">
      {{ element.tipTranzactie }}
	</ng-container>

	<!-- 🔸 Mod editare -->
	<ng-template #editTip>
	<mat-form-field appearance="outline" style="width: 180px">
		<mat-label>Tip tranzacție</mat-label>
		<mat-select [(ngModel)]="element.tipTranzactie">
			<mat-option *ngFor="let tip of tipuriTranzactie" [value]="tip">
            {{ tip }}
			</mat-option>
		</mat-select>
	</mat-form-field>
</ng-template>

</td>
</ng-container>

<ng-container matColumnDef="locked">
	<th mat-header-cell *matHeaderCellDef> 🔒</th>
<td mat-cell *matCellDef="let row">
	<span *ngIf="row.esteProcesata" title="Tranzacție blocată">
      🔒
	</span>
</td>

</ng-container>
	
<ng-container matColumnDef="actions">
	<th mat-header-cell *matHeaderCellDef> ⚙️</th>
<td mat-cell *matCellDef="let element">
	  
	<ng-container *ngIf="element.editing && element.id === 0">
		<button mat-icon-button color="primary" (click)="confirmTranzactieNoua(element)">✅</button>
		<button mat-icon-button color="warn" (click)="anuleazaTranzactieNoua(element)">❌</button>
	</ng-container>
	  
	<!-- Dacă nu e linie splitată -->
	<ng-container *ngIf="!element.isSplitChild">
		<button mat-icon-button color="accent" (click)="addSplitRow(element)">➕</button>
		<button mat-icon-button color="warn" (click)="removeSplitRow(element)">❌</button>
		<button mat-icon-button color="primary" (click)="confirmSplit(element)">✅</button>
		<button mat-icon-button color="accent" (click)="openFileDialog(element)">
  📎
		</button>
		<input type="file" #fileInput style="display:none" (change)="onFileSelected($event, element.id)" accept="image/*">
		</ng-container>

		<!-- Dacă e linie splitată -->
		<ng-container *ngIf="element.isSplitChild">
			<mat-form-field appearance="outline" class="split-suma">
				<mat-label>Sumă</mat-label>
				<input matInput type="number" [(ngModel)]="element.suma" (ngModelChange)="actualizeazaSoldFinal(element)"
				       class="sum-input"/>
			</mat-form-field>

			<mat-form-field appearance="outline" class="split-categorie">
				<mat-label>Categorie</mat-label>
				<input
 type="text"
				       matInput
				       [(ngModel)]="element.categorie"
				       [matAutocomplete]="auto"
/>
				<mat-autocomplete #auto="matAutocomplete">
					<mat-option *ngFor="let cat of categorii" [value]="cat">
                {{ cat }}
					</mat-option>
				</mat-autocomplete>
			</mat-form-field>

			<button mat-icon-button color="warn" (click)="removeSplitRow(element)">❌</button>
		</ng-container>
		
	</td>
</ng-container>


<!-- =========================
     CATEGORIE (COMBINATĂ)
========================= -->
<ng-container matColumnDef="categorie">
	<th mat-header-cell *matHeaderCellDef> 🏷️ Categorie</th>
<td mat-cell *matCellDef="let element">

	<!-- 🔹 Mod vizualizare (needitabil) -->
	<ng-container *ngIf="!element.editing; else editMode">

		<span
 [ngClass]="{
          'tigari-label badge-tigari': element.categorie?.toLowerCase().includes('tigari') 
                                       && !element.categorie?.toLowerCase().includes('bere'),
          'bere-label badge-bere': element.categorie?.toLowerCase().includes('bere') 
                                   && !element.categorie?.toLowerCase().includes('tigari'),
          'mixed-label': element.categorie?.toLowerCase().includes('tigari') 
                         && element.categorie?.toLowerCase().includes('bere')
        }">
        {{ element.categorie }}
		</span>

		<!-- 🔁 AutoSplit vizual -->
		<span *ngIf="element.detalii?.includes('🔁')"
		      matTooltip="AutoSplit generat automat din parser"
		      style="margin-left: 6px; color: #2196f3; font-size: 16px;">
        🔁
		</span>

		<!-- ✏️ Buton editare -->
		<button mat-icon-button color="primary" (click)="editCategorie(element)">
		
        ✏️
		</button>
		<button mat-icon-button
        color="accent"
        matTooltip="Ajustează partea personală (P&L)"
        (click)="openNetPersonalDialog(element)">
  <mat-icon>settings</mat-icon>
</button>
<button 
  mat-icon-button 
  color="accent"
  matTooltip="Adaugă automat țigări"
  (click)="adaugaCopilTigari(element)">
  🚬
</button>

	</ng-container>

	<!-- 🔹 Mod editare -->
	<ng-template #editMode>
	<mat-form-field appearance="outline" class="edit-dropdown">
		<mat-label>Categorie</mat-label>
		<mat-select [(ngModel)]="element.categorie">
			<mat-option *ngFor="let cat of categorii" [value]="cat">
            {{ cat }}
			</mat-option>
		</mat-select>
	</mat-form-field>

	<mat-checkbox [(ngModel)]="element.selected" title="Selectează pentru bulk"/>

	<button mat-icon-button color="primary" (click)="save(element)">✅</button>
	<button mat-icon-button color="warn" (click)="cancel(element)">❌</button>
</ng-template>

</td>
</ng-container>

<!-- 🍺 Nr. Beri -->
<ng-container matColumnDef="nrBeri">
  <th mat-header-cell *matHeaderCellDef>🍺 # Beri</th>
  <td mat-cell *matCellDef="let element">
    <ng-container *ngIf="element.categorie?.toUpperCase() === 'BERE'">
      <mat-form-field appearance="outline" style="width: 80px; position: relative;">
        <span class="icon-prefix bere-icon">🍺</span>
        <input
          matInput
          type="number"
          min="0"
          [(ngModel)]="element.nrBeri"
          (ngModelChange)="salveazaBeri(element)"
        />
      </mat-form-field>
    </ng-container>
  </td>
</ng-container>

<!-- 🚬 Nr. Țigări -->
<ng-container matColumnDef="nrTigari">
  <th mat-header-cell *matHeaderCellDef>🚬 # Țigări</th>
  <td mat-cell *matCellDef="let element">
    <ng-container *ngIf="element.categorie?.toUpperCase() === 'TIGARI'">
      <mat-form-field appearance="outline" style="width: 80px; position: relative;">
        <span class="icon-prefix tigari-icon">🚬</span>
        <input
          matInput
          type="number"
          min="0"
          [(ngModel)]="element.nrTigari"
          (ngModelChange)="salveazaTigari(element)"
        />
      </mat-form-field>
    </ng-container>
  </td>
</ng-container>

<!-- 🔹 Net Personal -->
<ng-container matColumnDef="netPersonal">
  <th mat-header-cell *matHeaderCellDef> NetPersonal </th>
  <td mat-cell *matCellDef="let element">
    <span *ngIf="element.netPersonal !== null && element.netPersonal !== undefined">
      {{ element.netPersonal | number:'1.2-2' }} lei
    </span>
    <span *ngIf="element.netPersonal === null || element.netPersonal === undefined" class="text-muted">
      -
    </span>
  </td>
</ng-container>
	
<!-- 🔹 ESTE PERSONAL --><!-- 🔹 ESTE PERSONAL -->
<ng-container matColumnDef="estePersonal">
  <th mat-header-cell *matHeaderCellDef> Personal </th>
  <td mat-cell *matCellDef="let element">
    <div style="display: flex; align-items: center; justify-content: center;">
      
      <!-- ✅ Verde aprins dacă este personal -->
      <mat-icon *ngIf="element.estePersonal" matTooltip="Tranzacție personală" style="color: #00ff66;">
        check_circle
      </mat-icon>

      <!-- ❌ Roșu aprins dacă NU este personal -->
      <mat-icon *ngIf="!element.estePersonal" matTooltip="Tranzacție comună / non-personală" style="color: #ff3b3b;"
>
        cancel
      </mat-icon>

    </div>
  </td>
</ng-container>






<!-- 🔹 Suma -->
<ng-container matColumnDef="suma">
	<th mat-header-cell *matHeaderCellDef
	    (click)="toggleColumnSum()"
	    [class.sum-active]="sumEntireColumn"
	    title="Click pentru total pe coloană / revenire la hover">
    Suma (lei)
	</th>

	<td mat-cell *matCellDef="let element; let i = index"
	    (mouseenter)="onHover(i, element.suma, element.tipTranzactie)"
	    (dblclick)="startEdit(element, 'suma')"
	    class="hover-cell editable-cell">

		<!-- 🔸 Vizualizare normală -->
		<ng-container *ngIf="!(editingCell?.id === element.id && editingCell?.field === 'suma'); else editMode">
			<strong>{{ element.suma | number:'1.2-2' }}</strong>
		</ng-container>

		<!-- 🔸 Mod editare -->
		<ng-template #editMode>
		<input type="number"
		       [(ngModel)]="editValue"
		       (keydown.enter)="saveEdit(element, 'suma')"
		       (keydown.escape)="cancelEdit()"
		       (blur)="saveEdit(element, 'suma')"
		       class="inline-input"
		       autofocus>
	</ng-template>

</td>
</ng-container>



<!-- Select -->
<ng-container matColumnDef="select">
	<th mat-header-cell *matHeaderCellDef> ✔</th>
<td mat-cell *matCellDef="let element">
	<mat-checkbox [(ngModel)]="element.selected"/>
</td>
</ng-container>

<!-- EsteCredit -->
<ng-container matColumnDef="esteCredit">
	<th mat-header-cell *matHeaderCellDef> Tip plată</th>
<td mat-cell *matCellDef="let element">
	<!-- 🔸 Vizualizare normală -->
	<ng-container *ngIf="!element.editing; else editTipPlata">
		<span [ngClass]="element.esteCredit ? 'credit' : 'debit'">
        {{ element.esteCredit ? 'Credit' : 'Debit' }}
		</span>
	</ng-container>

	<!-- 🔸 Mod editare -->
	<ng-template #editTipPlata>
	<mat-form-field appearance="outline" style="width: 120px;">
		<mat-label>Tip plată</mat-label>
		<mat-select [(ngModel)]="element.esteCredit" (selectionChange)="actualizeazaSoldFinal(element)">
			<mat-option [value]="true">Credit</mat-option>
			<mat-option [value]="false">Debit</mat-option>
		</mat-select>

	</mat-form-field>
</ng-template>
</td>
</ng-container>


<!-- SoldFinal -->
<ng-container matColumnDef="soldFinal">
	<th mat-header-cell *matHeaderCellDef> Sold final</th>
<td mat-cell *matCellDef="let element">{{ element.soldFinal | number:'1.2-2' }}</td>
</ng-container>

<!-- Data Decontarii -->
<ng-container matColumnDef="dataDecontarii">
	<th mat-header-cell *matHeaderCellDef> Data decontării</th>
<td mat-cell *matCellDef="let element">
        {{ element.dataDecontarii | date:'dd/MM/yyyy' }}
</td>
</ng-container>

<!-- NumarCard -->
<ng-container matColumnDef="numarCard">
	<th mat-header-cell *matHeaderCellDef> Nr. card</th>
<td mat-cell *matCellDef="let element">{{ element.numarCard }}</td>
</ng-container>
	
<!-- Merchant-->

<ng-container matColumnDef="merchant">
	<th mat-header-cell *matHeaderCellDef> Merchant</th>
<td mat-cell *matCellDef="let element">

	<!-- 🔄 Dacă e în mod editare, arată inputul -->
	<ng-container *ngIf="element.editing; else merchantDisplay">
		<input matInput [(ngModel)]="element.merchant" placeholder="Merchant"/>
	</ng-container>

	<!-- 🧾 Afișare normală cu pictograme OCR dacă nu e în editare -->
	<ng-template #merchantDisplay>
	<ng-container *ngIf="esteMagazinOCR(element.merchant); else normalMerchant">
        
		<!-- Părinte OCR -->
		<span *ngIf="!element.isSplitChild"
		      class="ocr-icon"
		      matTooltip="Atașează bon OCR pentru {{ element.merchant }}"
		      (click)="openFileDialog(element)">🧾</span>

		<!-- Copil OCR -->
		<span *ngIf="element.isSplitChild"
		      class="ocr-icon child"
		      matTooltip="{{ formatDetaliiTooltip(element) }}">📄</span>

		<strong>{{ element.merchant }}</strong>
	</ng-container>

	<!-- Caz general fără OCR -->
	<ng-template #normalMerchant>
	             {{ element.merchant }}
</ng-template>
</ng-template>
</td>
</ng-container>



<!-- Data Autorizarii -->
<ng-container matColumnDef="dataAutorizarii">
	<th mat-header-cell *matHeaderCellDef> Data autorizării</th>
<td mat-cell *matCellDef="let element">
        {{ element.dataAutorizarii | date:'dd/MM/yyyy' }}
</td>
</ng-container>

<!-- Numar Autorizare -->
<ng-container matColumnDef="numarAutorizare">
	<th mat-header-cell *matHeaderCellDef> Nr. autorizare</th>
<td mat-cell *matCellDef="let element">{{ element.numarAutorizare }}</td>
</ng-container>

<!-- Referinta -->
<ng-container matColumnDef="referinta">
	<th mat-header-cell *matHeaderCellDef> Referință</th>
<td mat-cell *matCellDef="let element">{{ element.referinta }}</td>
</ng-container>


<!-- Detalii -->
<ng-container matColumnDef="detalii">
	<th mat-header-cell *matHeaderCellDef> Detalii</th>
<td mat-cell *matCellDef="let element">
	<div class="detalii-cell">
		<span>{{ element.detalii }}</span>

		<span
 class="status-badge"
		      [ngClass]="element.esteProcesata ? 'procesata' : 'activa'">
      {{ element.esteProcesata ? 'Procesată ✅' : 'Activă 🟢' }}
		</span>
	</div>
</td>

</ng-container>

<!-- 🔹 Rândurile tabelului -->
<tr mat-row
  *matRowDef="let row; columns: displayedColumns;"
  [ngClass]="{
    'magazin-ocr': esteMagazinOCR(row.merchant),
    'new-child': row.isNewChild,
    'ocr-child': row.isSplitChild,
    'split-row': row.isSplitChild,
    'delete-highlight': row.highlightDelete,
    'credit-row': row.esteCredit && !row.isSplitChild && !row.isNewChild,
    'debit-row': !row.esteCredit && !row.isSplitChild && !row.isNewChild,
    'locked-row': row.esteProcesata && !row.detalii?.includes('🔁'),
    'auto-split-parent': row.detalii?.includes('🔁'),
    'tigari-row': row.categorie?.toLowerCase().includes('tigari') 
                  && !row.categorie?.toLowerCase().includes('bere'),
    'bere-row': row.categorie?.toLowerCase().includes('bere') 
                && !row.categorie?.toLowerCase().includes('tigari'),
    'mixed-row': row.categorie?.toLowerCase().includes('tigari') 
                 && row.categorie?.toLowerCase().includes('bere'),
    'special-row': row.detalii?.includes('|') || row.detalii?.includes('('),
    'incasare-row': row.tipTranzactie?.toLowerCase().includes('incasare') ||
      row.categorie?.toLowerCase().includes('salariu')
  }">
</tr>






</table>
</div>
</div>


<!-- 🟢 Buton plutitor pentru grafic -->
<button class="profit-chart-btn" (click)="toggleChartEvolutie()">
  📈
</button>

<!-- 🟣 Overlay pentru grafic -->
<div class="profit-chart-overlay" *ngIf="showChartEvolutie">
  <div class="chart-box">
    <div class="chart-header">
      <h3>📊 Evoluția Profitului Lunar</h3>
      <button class="close-btn" (click)="toggleChartEvolutie()">✖</button>
    </div>

    <canvas
      baseChart
      [data]="profitChartData"
      [options]="profitChartOptions"
      [type]="'line'">
    </canvas>
  </div>
</div>


<!-- 🌀 Overlay OCR Loading -->
<div class="ocr-overlay" *ngIf="isLoadingOcr">
	<div class="ocr-loader">
		<div class="spinner">
		<p>Se procesează bonul OCR...</p>
		<mat-progress-bar
 mode="determinate"
		                  [value]="uploadProgress"
		                  color="accent"
		                  class="progress-bar"
/>
		<p>{{ uploadProgress }}%</p>
	</div>
</div>

<!-- 🔹 Form adăugare categorie nouă -->
<div class="add-categorie-form">
	<mat-form-field appearance="outline" class="full-width">
		<mat-label>Categorie nouă</mat-label>
		<input
 type="text"
		       matInput
		       [formControl]="categorieControl"
		       [matAutocomplete]="autoCategorie"
		       placeholder="Tastează pentru a filtra sau adăuga"/>

		<mat-autocomplete #autoCategorie="matAutocomplete">
			<mat-option *ngFor="let cat of categoriiFiltrate | async" [value]="cat">
        {{ cat }}
			</mat-option>
			<mat-option
 *ngIf="categorieControl.value && !categorii.includes(categorieControl.value.trim().toUpperCase())"
			            [value]="categorieControl.value">
        ➕ Adaugă nouă:				<strong>{{ categorieControl.value }}</strong>
			</mat-option>
		</mat-autocomplete>
	</mat-form-field>

	<button mat-raised-button color="primary" (click)="adaugaCategorie()">➕ Adaugă</button>
</div>




